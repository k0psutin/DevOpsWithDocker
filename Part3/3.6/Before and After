#Before optimizing

FROM ruby:2.6.0

EXPOSE 3000

WORKDIR /app
COPY . /app

RUN apt-get update && apt-get install -y vim curl
RUN curl -sL https://deb.nodesource.com/setup_10.x | bash
RUN apt-get install -y nodejs

RUN gem install bundler
RUN bundle install

ENV RAILS_ENV=production

RUN rails db:migrate
RUN rake assets:precompile

ENV RAILS_LOG_TO_STDOU=true
ENV EDITOR=vim

CMD ["rails", "s", "-e", "production"]

# After

FROM ruby:2.6.0

WORKDIR /app
COPY . /app

ENV RAILS_ENV=production
ENV RAILS_LOG_TO_STDOU=true
ENV EDITOR=vim

RUN useradd -m ruby && \
    chown -hR ruby /app && \
    apt-get update && apt-get install -y vim curl && \
    curl -sL https://deb.nodesource.com/setup_10.x | bash && \
    apt-get install -y nodejs && \
    gem install bundler && \
    bundle install && \
    apt-get purge -y --auto-remove curl && \
    rails db:migrate && \
    rake assets:precompile && \
    rm -rf /var/lib/apt/lists/*

USER ruby

EXPOSE 3000

CMD ["rails", "s", "-e", "production"]
